<style>
@import url('https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap');

body { margin: 0; }
pre { font: 16px 'Fira Mono', monospace; line-height: 1.5; margin: 0; padding: 2rem }
pre { background-color: #f9fef5; color: #181a19; }

pre .comment { color: #94b996; font-style: italic; }
pre .keyword,
pre .string,
pre .number,
pre .nil,
pre .boolean { color: #8e9144; }
pre .symbol.special-symbol,
pre .symbol.macro-symbol,
pre .symbol.global-symbol { color: #448f22; font-weight: bold; }
</style><pre>
<span class="nonmatching "></span><span class="comment ">;; This module is responsible for turning bytes of source code into an AST
</span><span class="nonmatching "></span><span class="comment ">;; data structure.
</span><span class="nonmatching ">
</span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">local</span><span class="nonmatching "> </span><span class="symbol ">utils</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">require</span><span class="nonmatching "> </span><span class="keyword ">:fennel.utils</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
</span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">local</span><span class="nonmatching "> </span><span class="symbol ">friend</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">require</span><span class="nonmatching "> </span><span class="keyword ">:fennel.friend</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
</span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">local</span><span class="nonmatching "> </span><span class="symbol ">unpack</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="symbol global-symbol">table.unpack</span><span class="nonmatching "> </span><span class="symbol ">_G.unpack</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

</span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">granulate</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">getchunk</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
  </span><span class="string ">"Convert a stream of chunks to a stream of bytes.
Also returns a second function to clear the buffer in the byte stream"</span><span class="nonmatching ">
  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">var</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">c</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "> </span><span class="symbol ">done?</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">values</span><span class="nonmatching "> </span><span class="string ">""</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "> </span><span class="boolean ">false</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">values</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">parser-state</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="symbol ">done?</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">&lt;=</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">length</span><span class="nonmatching "> </span><span class="symbol ">c</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">c:byte</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
                    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">+</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                    </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">match</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getchunk</span><span class="nonmatching "> </span><span class="symbol ">parser-state</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">char</span><span class="nonmatching "> </span><span class="symbol ">?</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">char</span><span class="nonmatching "> </span><span class="string ">""</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">do</span><span class="nonmatching ">
                                              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">c</span><span class="nonmatching "> </span><span class="symbol ">char</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                                              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "> </span><span class="number ">2</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                                              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">c:byte</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                    </span><span class="symbol ">_</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">done?</span><span class="nonmatching "> </span><span class="boolean ">true</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol special-symbol">#</span><span class="nonmatching "></span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">c</span><span class="nonmatching "> </span><span class="string ">""</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

</span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">string-stream</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">str</span><span class="nonmatching "> </span><span class="symbol ">?options</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
  </span><span class="string ">"Convert a string into a stream of bytes."</span><span class="nonmatching ">
  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">str</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">str:gsub</span><span class="nonmatching "> </span><span class="string ">"^#!"</span><span class="nonmatching "> </span><span class="string ">";;"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "> </span><span class="comment ">; replace shebang with comment
</span><span class="nonmatching ">    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="symbol ">?options</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">?options.source</span><span class="nonmatching "> </span><span class="symbol ">str</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">var</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">r</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">str:byte</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">+</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="symbol ">r</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

</span><span class="comment ">;; Table of delimiter bytes - (, ), [, ], {, }
</span><span class="nonmatching "></span><span class="comment ">;; Opener keys have closer as the value; closers keys have true as their value.
</span><span class="nonmatching "></span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">local</span><span class="nonmatching "> </span><span class="symbol ">delims</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="number ">40</span><span class="nonmatching "> </span><span class="number ">41</span><span class="nonmatching "> </span><span class="number ">41</span><span class="nonmatching "> </span><span class="boolean ">true</span><span class="nonmatching "> </span><span class="number ">91</span><span class="nonmatching "> </span><span class="number ">93</span><span class="nonmatching "> </span><span class="number ">93</span><span class="nonmatching "> </span><span class="boolean ">true</span><span class="nonmatching "> </span><span class="number ">123</span><span class="nonmatching "> </span><span class="number ">125</span><span class="nonmatching "> </span><span class="number ">125</span><span class="nonmatching "> </span><span class="boolean ">true</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

</span><span class="comment ">;; fnlfmt: skip
</span><span class="nonmatching "></span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">sym-char?</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="keyword ">:number</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">type</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.byte</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">&lt;</span><span class="nonmatching "> </span><span class="number ">32</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
         </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">delims</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
         </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">127</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="comment ">; backspace
</span><span class="nonmatching ">         </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">34</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="comment ">; backslash
</span><span class="nonmatching ">         </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">39</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="comment ">; single quote
</span><span class="nonmatching ">         </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">126</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="comment ">; tilde
</span><span class="nonmatching ">         </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">59</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="comment ">; semicolon
</span><span class="nonmatching ">         </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">44</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="comment ">; comma
</span><span class="nonmatching ">         </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">64</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="comment ">; at
</span><span class="nonmatching ">         </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">96</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="comment ">; backtick
</span><span class="nonmatching ">         </span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

</span><span class="comment ">;; prefix chars substituted while reading
</span><span class="nonmatching "></span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">local</span><span class="nonmatching "> </span><span class="symbol ">prefixes</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="number ">35</span><span class="nonmatching "> </span><span class="keyword ">:hashfn</span><span class="nonmatching ">
                 </span><span class="comment ">;; non-backtick quote
</span><span class="nonmatching ">                 </span><span class="number ">39</span><span class="nonmatching "> </span><span class="keyword ">:quote</span><span class="nonmatching ">
                 </span><span class="number ">44</span><span class="nonmatching "> </span><span class="keyword ">:unquote</span><span class="nonmatching ">
                 </span><span class="number ">96</span><span class="nonmatching "> </span><span class="keyword ">:quote</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

</span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">char-starter?</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">&lt;</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">127</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">&lt;</span><span class="nonmatching "> </span><span class="number ">192</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">247</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

</span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parser-fn</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">getbyte</span><span class="nonmatching "> </span><span class="symbol ">filename</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">source</span><span class="nonmatching "> </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">unfriendly</span><span class="nonmatching "> </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">comments</span><span class="nonmatching "> </span><span class="symbol ">&amp;as</span><span class="nonmatching "> </span><span class="symbol ">options</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">var</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="comment ">; stack of unfinished values
</span><span class="nonmatching ">  </span><span class="comment ">;; Provide one character buffer and keep track of current line and byte index
</span><span class="nonmatching ">  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">var</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="symbol ">prev-col</span><span class="nonmatching "> </span><span class="symbol ">lastb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">values</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "> </span><span class="number ">0</span><span class="nonmatching "> </span><span class="number ">0</span><span class="nonmatching "> </span><span class="number ">0</span><span class="nonmatching "> </span><span class="nil ">nil</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">ungetb</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">ub</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">char-starter?</span><span class="nonmatching "> </span><span class="symbol ">ub</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">-</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">ub</span><span class="nonmatching "> </span><span class="number ">10</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">values</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">-</span><span class="nonmatching "> </span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">prev-col</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">-</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">lastb</span><span class="nonmatching "> </span><span class="symbol ">ub</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">getb</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">var</span><span class="nonmatching "> </span><span class="symbol ">r</span><span class="nonmatching "> </span><span class="nil ">nil</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="symbol ">lastb</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">r</span><span class="nonmatching "> </span><span class="symbol ">lastb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">values</span><span class="nonmatching "> </span><span class="symbol ">lastb</span><span class="nonmatching "> </span><span class="nil ">nil</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">r</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getbyte</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="keyword ">:stack-size</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">length</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">+</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="symbol ">r</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">char-starter?</span><span class="nonmatching "> </span><span class="symbol ">r</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">+</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">r</span><span class="nonmatching "> </span><span class="number ">10</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="symbol ">prev-col</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">values</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">+</span><span class="nonmatching "> </span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="number ">0</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
    </span><span class="symbol ">r</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">whitespace?</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">32</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">&lt;=</span><span class="nonmatching "> </span><span class="number ">9</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">13</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">?.</span><span class="nonmatching "> </span><span class="symbol ">options.whitespace</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

  </span><span class="comment ">;; If you add new calls to this function, please update fennel.friend as well
</span><span class="nonmatching ">  </span><span class="comment ">;; to add suggestions for how to fix the new error!
</span><span class="nonmatching ">  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">msg</span><span class="nonmatching "> </span><span class="symbol ">?col-adjust</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">+</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="symbol ">?col-adjust</span><span class="nonmatching "> </span><span class="number ">-1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="comment ">;; allow plugins to override parse-error
</span><span class="nonmatching ">      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="nil ">nil</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.hook-opts</span><span class="nonmatching "> </span><span class="keyword ">:parse-error</span><span class="nonmatching "> </span><span class="symbol ">options</span><span class="nonmatching "> </span><span class="symbol ">msg</span><span class="nonmatching "> </span><span class="symbol ">filename</span><span class="nonmatching ">
                               </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="string ">"?"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching ">
                               </span><span class="symbol ">source</span><span class="nonmatching "> </span><span class="symbol ">utils.root.reset</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.root.reset</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="symbol ">unfriendly</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="symbol ">_G.io</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="symbol ">_G.io.read</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.format</span><span class="nonmatching "> </span><span class="string ">"%s:%s:%s Parse error: %s"</span><span class="nonmatching ">
                                  </span><span class="symbol ">filename</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="string ">"?"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="symbol ">msg</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="number ">0</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">friend.parse-error</span><span class="nonmatching "> </span><span class="symbol ">msg</span><span class="nonmatching "> </span><span class="symbol ">filename</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="string ">"?"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="symbol ">source</span><span class="nonmatching "> </span><span class="symbol ">options</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parse-stream</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">var</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">whitespace-since-dispatch</span><span class="nonmatching "> </span><span class="symbol ">done?</span><span class="nonmatching "> </span><span class="symbol ">retval</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="boolean ">true</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">set-source-fields</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">source</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">source.byteend</span><span class="nonmatching "> </span><span class="symbol ">source.endcol</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">values</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">-</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">v</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="string ">"Dispatch when we complete a value"</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">match</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">length</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="nil ">nil</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">retval</span><span class="nonmatching "> </span><span class="symbol ">done?</span><span class="nonmatching "> </span><span class="symbol ">whitespace-since-dispatch</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">values</span><span class="nonmatching "> </span><span class="symbol ">v</span><span class="nonmatching "> </span><span class="boolean ">true</span><span class="nonmatching "> </span><span class="boolean ">false</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">prefix</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">source</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">doto</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.remove</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">set-source-fields</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                         </span><span class="symbol ">list</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.list</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.sym</span><span class="nonmatching "> </span><span class="symbol ">prefix</span><span class="nonmatching "> </span><span class="symbol ">source</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">v</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
                     </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">each</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">k</span><span class="nonmatching "> </span><span class="symbol ">v</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">pairs</span><span class="nonmatching "> </span><span class="symbol ">source</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
                       </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">tset</span><span class="nonmatching "> </span><span class="symbol ">list</span><span class="nonmatching "> </span><span class="symbol ">k</span><span class="nonmatching "> </span><span class="symbol ">v</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                     </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="symbol ">list</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="symbol ">top</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">do</span><span class="nonmatching ">
              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">whitespace-since-dispatch</span><span class="nonmatching "> </span><span class="boolean ">false</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.insert</span><span class="nonmatching "> </span><span class="symbol ">top</span><span class="nonmatching "> </span><span class="symbol ">v</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">badend</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="string ">"Throw nice error when we expect more characters but reach end of stream."</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">accum</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.map</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "> </span><span class="keyword ">:closer</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.format</span><span class="nonmatching "> </span><span class="string ">"expected closing delimiter%s %s"</span><span class="nonmatching ">
                                    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">length</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="string ">""</span><span class="nonmatching "> </span><span class="keyword ">:s</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                                    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.char</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">unpack</span><span class="nonmatching "> </span><span class="symbol ">accum</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">skip-whitespace</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">whitespace?</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">do</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">whitespace-since-dispatch</span><span class="nonmatching "> </span><span class="boolean ">true</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">skip-whitespace</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">&lt;</span><span class="nonmatching "> </span><span class="number ">0</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">length</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">badend</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parse-comment</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="symbol ">contents</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="number ">10</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-comment</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">doto</span><span class="nonmatching "> </span><span class="symbol ">contents</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.insert</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.char</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="symbol ">comments</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">do</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">ungetb</span><span class="nonmatching "> </span><span class="number ">10</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.comment</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.concat</span><span class="nonmatching "> </span><span class="symbol ">contents</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                                       </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">filename</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">open-table</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="symbol ">whitespace-since-dispatch</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">..</span><span class="nonmatching "> </span><span class="string ">"expected whitespace before opening delimiter "</span><span class="nonmatching ">
                         </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.char</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.insert</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="keyword ">:bytestart</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="keyword ">:closer</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">delims</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                           </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">filename</span><span class="nonmatching "> </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="keyword ">:col</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">-</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">close-list</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">list</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">setmetatable</span><span class="nonmatching "> </span><span class="symbol ">list</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">getmetatable</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.list</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">close-sequence</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">val</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.sequence</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">unpack</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
        </span><span class="comment ">;; for table literals we can't store file/line/offset source
</span><span class="nonmatching ">        </span><span class="comment ">;; data in fields on the table itself, because the AST node
</span><span class="nonmatching ">        </span><span class="comment ">;; *is* the table, and the fields would show up in the
</span><span class="nonmatching ">        </span><span class="comment ">;; compiled output. keep them on the metatable instead.
</span><span class="nonmatching ">        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">each</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">k</span><span class="nonmatching "> </span><span class="symbol ">v</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">pairs</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">tset</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">getmetatable</span><span class="nonmatching "> </span><span class="symbol ">val</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">k</span><span class="nonmatching "> </span><span class="symbol ">v</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="symbol ">val</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">add-comment-at</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">comments</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "> </span><span class="symbol ">node</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">match</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">comments</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="symbol ">existing</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.insert</span><span class="nonmatching "> </span><span class="symbol ">existing</span><span class="nonmatching "> </span><span class="symbol ">node</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="symbol ">_</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">tset</span><span class="nonmatching "> </span><span class="symbol ">comments</span><span class="nonmatching "> </span><span class="symbol ">index</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">node</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">next-noncomment</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.comment?</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">next-noncomment</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">+</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.sym</span><span class="nonmatching "> </span><span class="string ">":"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">tostring</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">+</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">extract-comments</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="string ">"Comment nodes can't be stored inside k/v tables; pull them out for later"</span><span class="nonmatching ">
      </span><span class="comment ">;; every comment either preceeds a key, preceeds a value, or is at the end
</span><span class="nonmatching ">      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">comments</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="keyword ">:keys</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching ">
                      </span><span class="keyword ">:values</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching ">
                      </span><span class="keyword ">:last</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">while</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.comment?</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">length</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.insert</span><span class="nonmatching "> </span><span class="symbol ">comments.last</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.remove</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">var</span><span class="nonmatching "> </span><span class="symbol ">last-key?</span><span class="nonmatching "> </span><span class="boolean ">false</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">each</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">i</span><span class="nonmatching "> </span><span class="symbol ">node</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">ipairs</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.comment?</span><span class="nonmatching "> </span><span class="symbol ">node</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">last-key?</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="symbol ">last-key?</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
              </span><span class="symbol ">last-key?</span><span class="nonmatching ">
              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">add-comment-at</span><span class="nonmatching "> </span><span class="symbol ">comments.values</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">next-noncomment</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">node</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">add-comment-at</span><span class="nonmatching "> </span><span class="symbol ">comments.keys</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">next-noncomment</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">node</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="comment ">;; strip out the comments in a second pass; if we did it in the first
</span><span class="nonmatching ">        </span><span class="comment ">;; pass we wouldn't be able to distinguish key-attached vs val-attached
</span><span class="nonmatching ">        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">for</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">i</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">length</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "> </span><span class="number ">-1</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.comment?</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.remove</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="symbol ">comments</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">close-curly-table</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">comments</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">extract-comments</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="symbol ">keys</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
            </span><span class="symbol ">val</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching ">% </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">length</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="number ">2</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="number ">0</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">-</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="string ">"expected even number of values in table literal"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">setmetatable</span><span class="nonmatching "> </span><span class="symbol ">val</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="comment ">; see note above about source data
</span><span class="nonmatching ">        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">for</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">i</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">length</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="number ">2</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">tostring</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="string ">":"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.sym?</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">+</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                     </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.sym?</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">tset</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">tostring</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">+</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">tset</span><span class="nonmatching "> </span><span class="symbol ">val</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">+</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.insert</span><span class="nonmatching "> </span><span class="symbol ">keys</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">tbl</span><span class="nonmatching "> </span><span class="symbol ">i</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">tbl.comments</span><span class="nonmatching "> </span><span class="symbol ">comments</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="comment ">;; save off the key order so the table can be reconstructed in order
</span><span class="nonmatching ">        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="symbol ">tbl.keys</span><span class="nonmatching "> </span><span class="symbol ">keys</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="symbol ">val</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">close-table</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">top</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.remove</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">top</span><span class="nonmatching "> </span><span class="nil ">nil</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">..</span><span class="nonmatching "> </span><span class="string ">"unexpected closing delimiter "</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.char</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="symbol ">top.closer</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">top.closer</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">..</span><span class="nonmatching "> </span><span class="string ">"mismatched closing delimiter "</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.char</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                           </span><span class="string ">", expected "</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.char</span><span class="nonmatching "> </span><span class="symbol ">top.closer</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">set-source-fields</span><span class="nonmatching "> </span><span class="symbol ">top</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">41</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">close-list</span><span class="nonmatching "> </span><span class="symbol ">top</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">93</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">close-sequence</span><span class="nonmatching "> </span><span class="symbol ">top</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">close-curly-table</span><span class="nonmatching "> </span><span class="symbol ">top</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parse-string-loop</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">chars</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="symbol ">state</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.insert</span><span class="nonmatching "> </span><span class="symbol ">chars</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">state</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">match</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">state</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
                    </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="keyword ">:base</span><span class="nonmatching "> </span><span class="number ">92</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "> </span><span class="keyword ">:backslash</span><span class="nonmatching ">
                    </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="keyword ">:base</span><span class="nonmatching "> </span><span class="number ">34</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "> </span><span class="keyword ">:done</span><span class="nonmatching ">
                    </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="keyword ">:backslash</span><span class="nonmatching "> </span><span class="number ">10</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">do</span><span class="nonmatching ">
                                      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.remove</span><span class="nonmatching "> </span><span class="symbol ">chars</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">-</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">length</span><span class="nonmatching "> </span><span class="symbol ">chars</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                                      </span><span class="keyword ">:base</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                    </span><span class="symbol ">_</span><span class="nonmatching "> </span><span class="keyword ">:base</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">state</span><span class="nonmatching "> </span><span class="keyword ">:done</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-string-loop</span><span class="nonmatching "> </span><span class="symbol ">chars</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">state</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">escape-char</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">c</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="number ">7</span><span class="nonmatching "> </span><span class="string ">"\\a"</span><span class="nonmatching "> </span><span class="number ">8</span><span class="nonmatching "> </span><span class="string ">"\\b"</span><span class="nonmatching "> </span><span class="number ">9</span><span class="nonmatching "> </span><span class="string ">"\\t"</span><span class="nonmatching "> </span><span class="number ">10</span><span class="nonmatching "> </span><span class="string ">"\\n"</span><span class="nonmatching "> </span><span class="number ">11</span><span class="nonmatching "> </span><span class="string ">"\\v"</span><span class="nonmatching "> </span><span class="number ">12</span><span class="nonmatching "> </span><span class="string ">"\\f"</span><span class="nonmatching "> </span><span class="number ">13</span><span class="nonmatching "> </span><span class="string ">"\\r"</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">c:byte</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parse-string</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.insert</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="keyword ">:closer</span><span class="nonmatching "> </span><span class="number ">34</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">chars</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="number ">34</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-string-loop</span><span class="nonmatching "> </span><span class="symbol ">chars</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="keyword ">:base</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">badend</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.remove</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">raw</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.char</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">unpack</span><span class="nonmatching "> </span><span class="symbol ">chars</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
              </span><span class="symbol ">formatted</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">raw:gsub</span><span class="nonmatching "> </span><span class="string ">"[\a-\r]"</span><span class="nonmatching "> </span><span class="symbol ">escape-char</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">match</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">rawget</span><span class="nonmatching "> </span><span class="symbol global-symbol">_G</span><span class="nonmatching "> </span><span class="keyword ">:loadstring</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol global-symbol">load</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">..</span><span class="nonmatching "> </span><span class="string ">"return "</span><span class="nonmatching "> </span><span class="symbol ">formatted</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="symbol ">load-fn</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">load-fn</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="nil ">nil</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">..</span><span class="nonmatching "> </span><span class="string ">"Invalid string: "</span><span class="nonmatching "> </span><span class="symbol ">raw</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parse-prefix</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="string ">"expand prefix byte into wrapping form eg. '`a' into '(quote a)'"</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.insert</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="keyword ">:prefix</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">prefixes</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">filename</span><span class="nonmatching "> </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">line</span><span class="nonmatching ">
                           </span><span class="keyword ">:bytestart</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="keyword ">:col</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">-</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">nextb</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">whitespace?</span><span class="nonmatching "> </span><span class="symbol ">nextb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="boolean ">true</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">delims</span><span class="nonmatching "> </span><span class="symbol ">nextb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">35</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="string ">"invalid whitespace after quoting prefix"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.remove</span><span class="nonmatching "> </span><span class="symbol ">stack</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.sym</span><span class="nonmatching "> </span><span class="string ">"#"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">ungetb</span><span class="nonmatching "> </span><span class="symbol ">nextb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parse-sym-loop</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">chars</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">sym-char?</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">do</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">table.insert</span><span class="nonmatching "> </span><span class="symbol ">chars</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-sym-loop</span><span class="nonmatching "> </span><span class="symbol ">chars</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">do</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">when</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching ">
              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">ungetb</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="symbol ">chars</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parse-number</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">rawstr</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="comment ">;; numbers can have underscores in the middle or end, but not at the start
</span><span class="nonmatching ">      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">number-with-stripped-underscores</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">rawstr:find</span><span class="nonmatching "> </span><span class="string ">"^_"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                                                  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">rawstr:gsub</span><span class="nonmatching "> </span><span class="string ">"_"</span><span class="nonmatching "> </span><span class="string ">""</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">rawstr:match</span><span class="nonmatching "> </span><span class="string ">"^%d"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">do</span><span class="nonmatching ">
              </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">tonumber</span><span class="nonmatching "> </span><span class="symbol ">number-with-stripped-underscores</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">..</span><span class="nonmatching "> </span><span class="string ">"could not read number \"</span><span class="nonmatching "></span><span class="string ">" rawstr
                                             "</span><span class="nonmatching ">\</span><span class="string ">""</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
              </span><span class="boolean ">true</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol macro-symbol">match</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">tonumber</span><span class="nonmatching "> </span><span class="symbol ">number-with-stripped-underscores</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
              </span><span class="symbol ">x</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">do</span><span class="nonmatching ">
                  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="symbol ">x</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                  </span><span class="boolean ">true</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
              </span><span class="symbol ">_</span><span class="nonmatching "> </span><span class="boolean ">false</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">check-malformed-sym</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">rawstr</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="comment ">;; for backwards-compatibility, special-case allowance of ~= but
</span><span class="nonmatching ">      </span><span class="comment ">;; all other uses of ~ are disallowed
</span><span class="nonmatching ">      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">col-adjust</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">pat</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">-</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">rawstr:find</span><span class="nonmatching "> </span><span class="symbol ">pat</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.len</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">rawstr:match</span><span class="nonmatching "> </span><span class="string ">"^~"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "> </span><span class="string ">"~="</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="string ">"invalid character: ~"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">rawstr:match</span><span class="nonmatching "> </span><span class="string ">"%.[0-9]"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">..</span><span class="nonmatching "> </span><span class="string ">"can't start multisym segment with a digit: "</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                       </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">col-adjust</span><span class="nonmatching "> </span><span class="string ">"%.[0-9]"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">rawstr:match</span><span class="nonmatching "> </span><span class="string ">"[%.:][%.:]"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "> </span><span class="string ">".."</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
               </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "> </span><span class="string ">"$..."</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">..</span><span class="nonmatching "> </span><span class="string ">"malformed multisym: "</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                       </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">col-adjust</span><span class="nonmatching "> </span><span class="string ">"[%.:][%.:]"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">and</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not=</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "> </span><span class="string ">":"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">rawstr:match</span><span class="nonmatching "> </span><span class="string ">":$"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">..</span><span class="nonmatching "> </span><span class="string ">"malformed multisym: "</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                       </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">col-adjust</span><span class="nonmatching "> </span><span class="string ">":$"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">rawstr:match</span><span class="nonmatching "> </span><span class="string ">":.+[%.:]"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">..</span><span class="nonmatching "> </span><span class="string ">"method must be last component of multisym: "</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
                       </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">col-adjust</span><span class="nonmatching "> </span><span class="string ">":.+[%.:]"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="symbol ">rawstr</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parse-sym</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "> </span><span class="comment ">; not just syms actually...
</span><span class="nonmatching ">      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">source</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="keyword ">:bytestart</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">filename</span><span class="nonmatching "> </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="keyword ">:col</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">-</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching ">
            </span><span class="symbol ">rawstr</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.char</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">unpack</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-sym-loop</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">set-source-fields</span><span class="nonmatching "> </span><span class="symbol ">source</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "> </span><span class="keyword ">:true</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="boolean ">true</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "> </span><span class="keyword ">:false</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="boolean ">false</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "> </span><span class="string ">"..."</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.varg</span><span class="nonmatching "> </span><span class="symbol ">source</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">rawstr:match</span><span class="nonmatching "> </span><span class="string ">"^:.+$"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">rawstr:sub</span><span class="nonmatching "> </span><span class="number ">2</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-number</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">dispatch</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.sym</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">check-malformed-sym</span><span class="nonmatching "> </span><span class="symbol ">rawstr</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">source</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parse-loop</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="nil ">nil</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">59</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-comment</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="string ">";"</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">type</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">delims</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="keyword ">:number</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">open-table</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">delims</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">close-table</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="number ">34</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-string</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">.</span><span class="nonmatching "> </span><span class="symbol ">prefixes</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-prefix</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">sym-char?</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.byte</span><span class="nonmatching "> </span><span class="string ">"~"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-sym</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">utils.hook-opts</span><span class="nonmatching "> </span><span class="keyword ">:illegal-char</span><span class="nonmatching "> </span><span class="symbol ">options</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "> </span><span class="symbol ">getb</span><span class="nonmatching "> </span><span class="symbol ">ungetb</span><span class="nonmatching "> </span><span class="symbol ">dispatch</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-error</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">..</span><span class="nonmatching "> </span><span class="string ">"invalid character: "</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">string.char</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
      </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">not</span><span class="nonmatching "> </span><span class="symbol ">b</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="nil ">nil</span><span class="nonmatching "> </span><span class="comment ">; EOF
</span><span class="nonmatching ">          </span><span class="symbol ">done?</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">values</span><span class="nonmatching "> </span><span class="boolean ">true</span><span class="nonmatching "> </span><span class="symbol ">retval</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
          </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-loop</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">skip-whitespace</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parse-loop</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">skip-whitespace</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">getb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">values</span><span class="nonmatching "> </span><span class="symbol ">parse-stream</span><span class="nonmatching "> </span><span class="symbol special-symbol">#</span><span class="nonmatching "></span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">set</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">stack</span><span class="nonmatching "> </span><span class="symbol ">line</span><span class="nonmatching "> </span><span class="symbol ">byteindex</span><span class="nonmatching "> </span><span class="symbol ">col</span><span class="nonmatching "> </span><span class="symbol ">lastb</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">values</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching "> </span><span class="number ">1</span><span class="nonmatching "> </span><span class="number ">0</span><span class="nonmatching "> </span><span class="number ">0</span><span class="nonmatching "> </span><span class="nil ">nil</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

</span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">fn</span><span class="nonmatching "> </span><span class="symbol ">parser</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">stream-or-string</span><span class="nonmatching "> </span><span class="symbol ">?filename</span><span class="nonmatching "> </span><span class="symbol ">?options</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
  </span><span class="string ">"Returns an iterator fn which parses string-or-stream and returns AST nodes.
On success, returns true and the AST node. Returns nil when it reaches the end."</span><span class="nonmatching ">
  </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">let</span><span class="nonmatching "> </span><span class="bracket ">[</span><span class="nonmatching "></span><span class="symbol ">filename</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="symbol ">?filename</span><span class="nonmatching "> </span><span class="keyword ">:unknown</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="symbol ">options</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">or</span><span class="nonmatching "> </span><span class="symbol ">?options</span><span class="nonmatching "> </span><span class="symbol ">utils.root.options</span><span class="nonmatching "> </span><span class="bracket ">{</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">]</span><span class="nonmatching ">
    </span><span class="comment ">;; it's really easy to accidentally pass an options table here because all
</span><span class="nonmatching ">    </span><span class="comment ">;; the other fennel functions take the options table as the second arg!
</span><span class="nonmatching ">    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">assert</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="keyword ">:string</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">type</span><span class="nonmatching "> </span><span class="symbol ">filename</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
            </span><span class="string ">"expected filename as second argument to parser"</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
    </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">if</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol special-symbol">=</span><span class="nonmatching "> </span><span class="keyword ">:string</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol global-symbol">type</span><span class="nonmatching "> </span><span class="symbol ">stream-or-string</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parser-fn</span><span class="nonmatching "> </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">string-stream</span><span class="nonmatching "> </span><span class="symbol ">stream-or-string</span><span class="nonmatching "> </span><span class="symbol ">options</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "> </span><span class="symbol ">filename</span><span class="nonmatching "> </span><span class="symbol ">options</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">
        </span><span class="bracket ">(</span><span class="nonmatching "></span><span class="symbol ">parser-fn</span><span class="nonmatching "> </span><span class="symbol ">stream-or-string</span><span class="nonmatching "> </span><span class="symbol ">filename</span><span class="nonmatching "> </span><span class="symbol ">options</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching "></span><span class="bracket ">)</span><span class="nonmatching ">

</span><span class="bracket ">{</span><span class="nonmatching "></span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">granulate</span><span class="nonmatching "> </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">parser</span><span class="nonmatching "> </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">string-stream</span><span class="nonmatching "> </span><span class="symbol special-symbol">:</span><span class="nonmatching "> </span><span class="symbol ">sym-char?</span><span class="nonmatching "></span><span class="bracket ">}</span><span class="nonmatching ">


</span>
