<style>
@import url('https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap');

body { background-color: #f9fef5; margin: 0; }
pre { font: 16px 'Fira Mono', monospace; line-height: 1.5; margin: 0; padding: 2rem }
pre { color: #181a19; }

pre .comment { color: #94b996; font-style: italic; }
pre .keyword,
pre .string,
pre .number,
pre .nil,
pre .boolean { color: #8e9144; }
pre .symbol.special,
pre .symbol.macro,
pre .symbol.global { color: #448f22; font-weight: bold; }
</style><pre>
<span class="nonmatching"></span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">fn</span><span class="nonmatching"> </span><span class="symbol">scan</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">source</span><span class="nonmatching"> </span><span class="symbol">rules</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">var</span><span class="nonmatching"> </span><span class="symbol">current-index</span><span class="nonmatching"> </span><span class="number">1</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">var</span><span class="nonmatching"> </span><span class="symbol">last-matching-at</span><span class="nonmatching"> </span><span class="number">0</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">

  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">fn</span><span class="nonmatching"> </span><span class="symbol">at-eof?</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
    </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">></span><span class="nonmatching"> </span><span class="symbol">current-index</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol global">string.len</span><span class="nonmatching"> </span><span class="symbol">source</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">

  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">fn</span><span class="nonmatching"> </span><span class="symbol">advance</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">n</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
    </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">set</span><span class="nonmatching"> </span><span class="symbol">current-index</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">+</span><span class="nonmatching"> </span><span class="symbol">current-index</span><span class="nonmatching"> </span><span class="symbol">n</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">

  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">fn</span><span class="nonmatching"> </span><span class="symbol">yield-nonmatching</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
    </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol macro">when</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">&lt;</span><span class="nonmatching"> </span><span class="number">0</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">-</span><span class="nonmatching"> </span><span class="symbol">current-index</span><span class="nonmatching"> </span><span class="symbol">last-matching-at</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
      </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">let</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">nonmatching</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol global">string.sub</span><span class="nonmatching"> </span><span class="symbol">source</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">+</span><span class="nonmatching"> </span><span class="symbol">last-matching-at</span><span class="nonmatching"> </span><span class="number">1</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">-</span><span class="nonmatching"> </span><span class="symbol">current-index</span><span class="nonmatching"> </span><span class="number">1</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
        </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol global">coroutine.yield</span><span class="nonmatching"> </span><span class="keyword">:nonmatching</span><span class="nonmatching"> </span><span class="symbol">nonmatching</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">

  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">fn</span><span class="nonmatching"> </span><span class="symbol">yield-and-advance</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">class</span><span class="nonmatching"> </span><span class="symbol">matched</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
    </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol">yield-nonmatching</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
    </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol global">coroutine.yield</span><span class="nonmatching"> </span><span class="symbol">class</span><span class="nonmatching"> </span><span class="symbol">matched</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
    </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol">advance</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol global">string.len</span><span class="nonmatching"> </span><span class="symbol">matched</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
    </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">set</span><span class="nonmatching"> </span><span class="symbol">last-matching-at</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">-</span><span class="nonmatching"> </span><span class="symbol">current-index</span><span class="nonmatching"> </span><span class="number">1</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">

  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">fn</span><span class="nonmatching"> </span><span class="symbol">test-rules</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">rules</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
    </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol macro">accumulate</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">matching-rule</span><span class="nonmatching"> </span><span class="nil">nil</span><span class="nonmatching">
                 </span><span class="symbol">_</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">class</span><span class="nonmatching"> </span><span class="symbol">pattern</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol global">ipairs</span><span class="nonmatching"> </span><span class="symbol">rules</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
                 </span><span class="symbol">&amp;until</span><span class="nonmatching"> </span><span class="symbol">matching-rule</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
      </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol macro">case</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol global">string.match</span><span class="nonmatching"> </span><span class="symbol">source</span><span class="nonmatching"> </span><span class="symbol">pattern</span><span class="nonmatching"> </span><span class="symbol">current-index</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
        </span><span class="symbol">str</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">class</span><span class="nonmatching"> </span><span class="symbol">str</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">

  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">while</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">not</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol">at-eof?</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
    </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol macro">case</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol">test-rules</span><span class="nonmatching"> </span><span class="symbol">rules</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
      </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">class</span><span class="nonmatching"> </span><span class="symbol">str</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol">yield-and-advance</span><span class="nonmatching"> </span><span class="symbol">class</span><span class="nonmatching"> </span><span class="symbol">str</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
      </span><span class="symbol">_</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol">advance</span><span class="nonmatching"> </span><span class="number">1</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol">yield-nonmatching</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"> </span><span class="comment">; To release any final characters
</span><span class="nonmatching">
</span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">fn</span><span class="nonmatching"> </span><span class="symbol">token->html</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">class</span><span class="nonmatching"> </span><span class="symbol">value</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">let</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">escaped-value</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol macro">-></span><span class="nonmatching"> </span><span class="symbol">value</span><span class="nonmatching">
                        </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol global">string.gsub</span><span class="nonmatching"> </span><span class="string">"&amp;"</span><span class="nonmatching"> </span><span class="string">"&amp;amp;"</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
                        </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol global">string.gsub</span><span class="nonmatching"> </span><span class="string">"&lt;"</span><span class="nonmatching"> </span><span class="string">"&amp;lt;"</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
    </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol global">string.format</span><span class="nonmatching"> </span><span class="string">"&lt;span class=\"%s\">%s&lt;/span>"</span><span class="nonmatching"> </span><span class="symbol">class</span><span class="nonmatching"> </span><span class="symbol">escaped-value</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">

</span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">local</span><span class="nonmatching"> </span><span class="symbol">fennel-rules</span><span class="nonmatching">
  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">let</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">symbol-char</span><span class="nonmatching"> </span><span class="string">"!%$&amp;#%*%+%-%./:&lt;=>%?%^_%w"</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
    </span><span class="bracket">[</span><span class="nonmatching"></span><span class="bracket">[</span><span class="nonmatching"></span><span class="keyword">:comment</span><span class="nonmatching"> </span><span class="string">"^(;[^\n]*[\n])"</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
     </span><span class="bracket">[</span><span class="nonmatching"></span><span class="keyword">:string</span><span class="nonmatching"> </span><span class="string">"^(\"\")"</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
     </span><span class="bracket">[</span><span class="nonmatching"></span><span class="keyword">:string</span><span class="nonmatching"> </span><span class="string">"^(\".-[^\\]\")"</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
     </span><span class="bracket">[</span><span class="nonmatching"></span><span class="keyword">:keyword</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">..</span><span class="nonmatching"> </span><span class="string">"^(:["</span><span class="nonmatching"> </span><span class="symbol">symbol-char</span><span class="nonmatching"> </span><span class="string">"]+)"</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
     </span><span class="bracket">[</span><span class="nonmatching"></span><span class="keyword">:number</span><span class="nonmatching"> </span><span class="string">"^([%+%-]?%d+[xX]?%d*%.?%d?)"</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
     </span><span class="bracket">[</span><span class="nonmatching"></span><span class="keyword">:nil</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">..</span><span class="nonmatching"> </span><span class="string">"^(nil)[^"</span><span class="nonmatching"> </span><span class="symbol">symbol-char</span><span class="nonmatching"> </span><span class="string">"]"</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
     </span><span class="bracket">[</span><span class="nonmatching"></span><span class="keyword">:boolean</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">..</span><span class="nonmatching"> </span><span class="string">"^(true)[^"</span><span class="nonmatching"> </span><span class="symbol">symbol-char</span><span class="nonmatching"> </span><span class="string">"]"</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
     </span><span class="bracket">[</span><span class="nonmatching"></span><span class="keyword">:boolean</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">..</span><span class="nonmatching"> </span><span class="string">"^(false)[^"</span><span class="nonmatching"> </span><span class="symbol">symbol-char</span><span class="nonmatching"> </span><span class="string">"]"</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
     </span><span class="bracket">[</span><span class="nonmatching"></span><span class="keyword">:symbol</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">..</span><span class="nonmatching"> </span><span class="string">"^(["</span><span class="nonmatching"> </span><span class="symbol">symbol-char</span><span class="nonmatching"> </span><span class="string">"]+)"</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
     </span><span class="bracket">[</span><span class="nonmatching"></span><span class="keyword">:bracket</span><span class="nonmatching"> </span><span class="string">"^([%(%)%[%]{}])"</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">

</span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">fn</span><span class="nonmatching"> </span><span class="symbol">fennel->html</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">syntax</span><span class="nonmatching"> </span><span class="symbol">source</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
  </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol macro">icollect</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">class</span><span class="nonmatching"> </span><span class="symbol">value</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol global">coroutine.wrap</span><span class="nonmatching"> </span><span class="symbol special">#</span><span class="nonmatching"></span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol">scan</span><span class="nonmatching"> </span><span class="symbol">source</span><span class="nonmatching"> </span><span class="symbol">fennel-rules</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
    </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">let</span><span class="nonmatching"> </span><span class="bracket">[</span><span class="nonmatching"></span><span class="symbol">extra</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol macro">case</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">.</span><span class="nonmatching"> </span><span class="symbol">syntax</span><span class="nonmatching"> </span><span class="symbol">value</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
                  </span><span class="bracket">{</span><span class="nonmatching"></span><span class="keyword">:special?</span><span class="nonmatching"> </span><span class="boolean">true</span><span class="nonmatching"></span><span class="bracket">}</span><span class="nonmatching"> </span><span class="keyword">:special</span><span class="nonmatching">
                  </span><span class="bracket">{</span><span class="nonmatching"></span><span class="keyword">:macro?</span><span class="nonmatching"> </span><span class="boolean">true</span><span class="nonmatching"></span><span class="bracket">}</span><span class="nonmatching"> </span><span class="keyword">:macro</span><span class="nonmatching">
                  </span><span class="bracket">{</span><span class="nonmatching"></span><span class="keyword">:global?</span><span class="nonmatching"> </span><span class="boolean">true</span><span class="nonmatching"></span><span class="bracket">}</span><span class="nonmatching"> </span><span class="keyword">:global</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
          </span><span class="symbol">class*</span><span class="nonmatching"> </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">if</span><span class="nonmatching"> </span><span class="symbol">extra</span><span class="nonmatching">
                   </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol special">..</span><span class="nonmatching"> </span><span class="symbol">class</span><span class="nonmatching"> </span><span class="string">" "</span><span class="nonmatching"> </span><span class="symbol">extra</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">
                   </span><span class="symbol">class</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">]</span><span class="nonmatching">
      </span><span class="bracket">(</span><span class="nonmatching"></span><span class="symbol">token->html</span><span class="nonmatching"> </span><span class="symbol">class*</span><span class="nonmatching"> </span><span class="symbol">value</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching"></span><span class="bracket">)</span><span class="nonmatching">

</span><span class="bracket">{</span><span class="nonmatching"></span><span class="symbol special">:</span><span class="nonmatching"> </span><span class="symbol">fennel->html</span><span class="nonmatching">
 </span><span class="keyword">:fennel_to_html</span><span class="nonmatching"> </span><span class="symbol">fennel->html</span><span class="nonmatching"></span><span class="bracket">}</span><span class="nonmatching">
</span>