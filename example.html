<style>
@import url('https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap');

body { background-color: #f9fef5; margin: 0; }
pre { font: 16px 'Fira Mono', monospace; line-height: 1.5; margin: 0; padding: 2rem }
pre { color: #181a19; }

pre .comment { color: #94b996; font-style: italic; }
pre .keyword,
pre .string,
pre .number,
pre .nil,
pre .boolean { color: #8e9144; }
pre .symbol.special,
pre .symbol.macro,
pre .symbol.global { color: #448f22 }
pre .symbol.special { font-weight: bold; }
</style><pre>
(<span class="symbol special">fn</span> <span class="symbol">scan</span> [<span class="symbol">source</span> <span class="symbol">rules</span>]
  (<span class="symbol special">var</span> <span class="symbol">current-index</span> <span class="number">1</span>)
  (<span class="symbol special">var</span> <span class="symbol">last-matching-at</span> <span class="number">0</span>)

  (<span class="symbol special">fn</span> <span class="symbol">at-eof?</span> []
    (<span class="symbol special">></span> <span class="symbol">current-index</span> (<span class="symbol global">string.len</span> <span class="symbol">source</span>)))

  (<span class="symbol special">fn</span> <span class="symbol">advance</span> [<span class="symbol">n</span>]
    (<span class="symbol special">set</span> <span class="symbol">current-index</span> (<span class="symbol special">+</span> <span class="symbol">current-index</span> <span class="symbol">n</span>)))

  (<span class="symbol special">fn</span> <span class="symbol">yield-nonmatching</span> []
    (<span class="symbol special">if</span> (<span class="symbol special">></span> <span class="symbol">current-index</span> (<span class="symbol special">+</span> <span class="number">1</span> <span class="symbol">last-matching-at</span>))
        (<span class="symbol special">let</span> [<span class="symbol">nonmatching</span> (<span class="symbol global">string.sub</span> <span class="symbol">source</span>
                                      (<span class="symbol special">+</span> <span class="symbol">last-matching-at</span> <span class="number">1</span>)
                                      (<span class="symbol special">-</span> <span class="symbol">current-index</span> <span class="number">1</span>))]
          (<span class="symbol global">coroutine.yield</span> <span class="keyword">:nonmatching</span> <span class="symbol">nonmatching</span>))))

  (<span class="symbol special">fn</span> <span class="symbol">yield-and-advance</span> [<span class="symbol">class</span> <span class="symbol">matched</span>]
    (<span class="symbol">yield-nonmatching</span>)
    (<span class="symbol global">coroutine.yield</span> <span class="symbol">class</span> <span class="symbol">matched</span>)
    (<span class="symbol">advance</span> (<span class="symbol global">string.len</span> <span class="symbol">matched</span>))
    (<span class="symbol special">set</span> <span class="symbol">last-matching-at</span> (<span class="symbol special">-</span> <span class="symbol">current-index</span> <span class="number">1</span>)))

  (<span class="symbol special">fn</span> <span class="symbol">test-rules</span> [<span class="symbol">rules</span>]
    (<span class="symbol macro">accumulate</span> [<span class="symbol">matching-rule</span> <span class="nil">nil</span>
                 <span class="symbol">_</span> [<span class="symbol">class</span> <span class="symbol">pattern</span>] (<span class="symbol global">ipairs</span> <span class="symbol">rules</span>)
                 <span class="symbol">&amp;until</span> <span class="symbol">matching-rule</span>]
      (<span class="symbol macro">case</span> (<span class="symbol global">string.match</span> <span class="symbol">source</span> <span class="symbol">pattern</span> <span class="symbol">current-index</span>)
        <span class="symbol">str</span> [<span class="symbol">class</span> <span class="symbol">str</span>])))

  (<span class="symbol special">while</span> (<span class="symbol special">not</span> (<span class="symbol">at-eof?</span>))
    (<span class="symbol macro">case</span> (<span class="symbol">test-rules</span> <span class="symbol">rules</span>)
      [<span class="symbol">class</span> <span class="symbol">str</span>] (<span class="symbol">yield-and-advance</span> <span class="symbol">class</span> <span class="symbol">str</span>)
      <span class="symbol">_</span> (<span class="symbol">advance</span> <span class="number">1</span>)))
  (<span class="symbol">yield-nonmatching</span>)) <span class="comment">; To release any final characters
</span>
(<span class="symbol special">fn</span> <span class="symbol">->html</span> [<span class="symbol">syntax</span> <span class="symbol">rules</span> <span class="symbol">source</span>]
  (<span class="symbol macro">icollect</span> [<span class="symbol">class</span> <span class="symbol">value</span> (<span class="symbol global">coroutine.wrap</span> <span class="symbol special">#</span>(<span class="symbol">scan</span> <span class="symbol">source</span> <span class="symbol">rules</span>))]
    (<span class="symbol special">if</span> (<span class="symbol special">=</span> <span class="keyword">:nonmatching</span> <span class="symbol">class</span>)
        <span class="symbol">value</span>
        (<span class="symbol special">let</span> [<span class="symbol">extra</span> (<span class="symbol special">if</span> (<span class="symbol special">=</span> <span class="keyword">:symbol</span> <span class="symbol">class</span>)
                        (<span class="symbol macro">case</span> (<span class="symbol special">.</span> <span class="symbol">syntax</span> <span class="symbol">value</span>)
                          {<span class="keyword">:special?</span> <span class="boolean">true</span>} <span class="keyword">:special</span>
                          {<span class="keyword">:macro?</span> <span class="boolean">true</span>} <span class="keyword">:macro</span>
                          {<span class="keyword">:global?</span> <span class="boolean">true</span>} <span class="keyword">:global</span>))
              <span class="symbol">extended-class</span> (<span class="symbol special">if</span> <span class="symbol">extra</span>
                                 (<span class="symbol special">..</span> <span class="symbol">class</span> <span class="string">" "</span> <span class="symbol">extra</span>)
                                 <span class="symbol">class</span>)
              <span class="symbol">escaped-value</span> (<span class="symbol macro">-></span> <span class="symbol">value</span>
                            (<span class="symbol global">string.gsub</span> <span class="string">"&amp;"</span> <span class="string">"&amp;amp;"</span>)
                            (<span class="symbol global">string.gsub</span> <span class="string">"&lt;"</span> <span class="string">"&amp;lt;"</span>))]
          (<span class="symbol global">string.format</span> <span class="string">"&lt;span class=\"%s\">%s&lt;/span>"</span> <span class="symbol">extended-class</span> <span class="symbol">escaped-value</span>)))))

(<span class="symbol special">local</span> <span class="symbol">fennel-rules</span>
  (<span class="symbol special">let</span> [<span class="symbol">symbol-char</span> <span class="string">"!%$&amp;#%*%+%-%./:&lt;=>%?%^_a-zA-Z0-9"</span>]
    [[<span class="keyword">:comment</span> <span class="string">"^(;[^\n]*[\n])"</span>]
     [<span class="keyword">:string</span> <span class="string">"^(\"\")"</span>]
     [<span class="keyword">:string</span> <span class="string">"^(\".-[^\\]\")"</span>]
     [<span class="keyword">:keyword</span> (<span class="symbol special">..</span> <span class="string">"^(:["</span> <span class="symbol">symbol-char</span> <span class="string">"]+)"</span>)]
     [<span class="keyword">:number</span> <span class="string">"^([%+%-]?%d+[xX]?%d*%.?%d?)"</span>]
     [<span class="keyword">:nil</span> (<span class="symbol special">..</span> <span class="string">"^(nil)[^"</span> <span class="symbol">symbol-char</span> <span class="string">"]"</span>)]
     [<span class="keyword">:boolean</span> (<span class="symbol special">..</span> <span class="string">"^(true)[^"</span> <span class="symbol">symbol-char</span> <span class="string">"]"</span>)]
     [<span class="keyword">:boolean</span> (<span class="symbol special">..</span> <span class="string">"^(false)[^"</span> <span class="symbol">symbol-char</span> <span class="string">"]"</span>)]
     [<span class="keyword">:symbol</span> (<span class="symbol special">..</span> <span class="string">"^(["</span> <span class="symbol">symbol-char</span> <span class="string">"]+)"</span>)]]))
     <span class="comment">;[:bracket "^([%(%)%[%]{}])"] ; Too noisy for regular use
</span>     <span class="comment">;[:whitespace "^([ \n\t]+)"]
</span>
(<span class="symbol special">fn</span> <span class="symbol">fennel->html</span> [<span class="symbol">syntax</span> <span class="symbol">source</span>]
  (<span class="symbol">->html</span> <span class="symbol">syntax</span> <span class="symbol">fennel-rules</span> <span class="symbol">source</span>))

(<span class="symbol special">local</span> <span class="symbol">lua-keywords</span> [<span class="keyword">:and</span> <span class="keyword">:break</span> <span class="keyword">:do</span> <span class="keyword">:else</span> <span class="keyword">:elseif</span> <span class="keyword">:end</span> <span class="keyword">:for</span> <span class="keyword">:function</span> <span class="keyword">:goto</span> <span class="keyword">:if</span>
                     <span class="keyword">:in</span> <span class="keyword">:local</span> <span class="keyword">:not</span> <span class="keyword">:or</span> <span class="keyword">:repeat</span> <span class="keyword">:return</span> <span class="keyword">:then</span> <span class="keyword">:until</span> <span class="keyword">:while</span>])

(<span class="symbol special">fn</span> <span class="symbol">fennel-syntax->lua-syntax</span> [<span class="symbol">fennel-syntax</span>]
  (<span class="symbol special">local</span> <span class="symbol">lua-syntax</span> {})
  (<span class="symbol macro">collect</span> [<span class="symbol">k</span> <span class="symbol">v</span> (<span class="symbol global">pairs</span> <span class="symbol">fennel-syntax</span>) <span class="symbol">&amp;into</span> <span class="symbol">lua-syntax</span>]
    (<span class="symbol special">if</span> (<span class="symbol special">or</span> <span class="symbol">v.global?</span> <span class="symbol">v.special?</span>)
        (<span class="symbol special">values</span> <span class="symbol">k</span> <span class="symbol">v</span>)))
  (<span class="symbol macro">collect</span> [<span class="symbol">_</span> <span class="symbol">k</span> (<span class="symbol global">ipairs</span> <span class="symbol">lua-keywords</span>) <span class="symbol">&amp;into</span> <span class="symbol">lua-syntax</span>]
    (<span class="symbol special">values</span> <span class="symbol">k</span> {<span class="keyword">:special?</span> <span class="boolean">true</span>}))
  <span class="symbol">lua-syntax</span>)

(<span class="symbol special">local</span> <span class="symbol">lua-rules</span>
  (<span class="symbol special">let</span> [<span class="symbol">symbol-char-first</span> <span class="string">"a-zA-Z_"</span>
        <span class="symbol">symbol-char-rest</span> (<span class="symbol special">..</span> <span class="symbol">symbol-char-first</span> <span class="string">"0-9%."</span>)]
    [[<span class="keyword">:comment</span> <span class="string">"^(%-%-%[===%[.-]===])"</span>]
     [<span class="keyword">:comment</span> <span class="string">"^(%-%-%[==%[.-]==])"</span>]
     [<span class="keyword">:comment</span> <span class="string">"^(%-%-%[=%[.-]=])"</span>]
     [<span class="keyword">:comment</span> <span class="string">"^(%-%-%[%[.-]])"</span>]
     [<span class="keyword">:comment</span> <span class="string">"^(%-%-[^\n]*[\n])"</span>]
     [<span class="keyword">:string</span> <span class="string">"^(\"\")"</span>]
     [<span class="keyword">:string</span> <span class="string">"^(%[%[.-]])"</span>]
     [<span class="keyword">:string</span> <span class="string">"^(\".-[^\\]\")"</span>]
     [<span class="keyword">:string</span> <span class="string">"^('.-[^\\]')"</span>]
     [<span class="keyword">:number</span> <span class="string">"^(0[xX][0-9a-fA-F]?%.[0-9a-fA-F]+[eE][+-]?[0-9]?)"</span>]
     [<span class="keyword">:number</span> <span class="string">"^(0[xX][0-9a-fA-F]+[eE][+-]?[0-9]?)"</span>]
     [<span class="keyword">:number</span> <span class="string">"^(0[xX][0-9a-fA-F]?%.[0-9a-fA-F]+)"</span>]
     [<span class="keyword">:number</span> <span class="string">"^(0[xX][0-9a-fA-F]+)"</span>]
     [<span class="keyword">:number</span> <span class="string">"^([0-9]?%.[0-9]+[eE][+-]?[0-9]?)"</span>]
     [<span class="keyword">:number</span> <span class="string">"^([0-9]+[eE][+-]?[0-9]?)"</span>]
     [<span class="keyword">:number</span> <span class="string">"^([0-9]?%.[0-9]+)"</span>]
     [<span class="keyword">:number</span> <span class="string">"^([0-9]+)"</span>]
     [<span class="keyword">:nil</span> (<span class="symbol special">..</span> <span class="string">"^(nil)[^"</span> <span class="symbol">symbol-char-rest</span> <span class="string">"]"</span>)]
     [<span class="keyword">:boolean</span> (<span class="symbol special">..</span> <span class="string">"^(true)[^"</span> <span class="symbol">symbol-char-rest</span> <span class="string">"]"</span>)]
     [<span class="keyword">:boolean</span> (<span class="symbol special">..</span> <span class="string">"^(false)[^"</span> <span class="symbol">symbol-char-rest</span> <span class="string">"]"</span>)]
     [<span class="keyword">:symbol</span> (<span class="symbol special">..</span> <span class="string">"^(["</span> <span class="symbol">symbol-char-first</span> <span class="string">"]["</span> <span class="symbol">symbol-char-rest</span> <span class="string">"]*)"</span>)]
     [<span class="keyword">:symbol</span> <span class="string">"^(&lt;=)"</span>]
     [<span class="keyword">:symbol</span> <span class="string">"^(>=)"</span>]
     [<span class="keyword">:symbol</span> <span class="string">"^(==)"</span>]
     [<span class="keyword">:symbol</span> <span class="string">"^(~=)"</span>]
     [<span class="keyword">:symbol</span> <span class="string">"^(%.%.)"</span>]
     [<span class="keyword">:symbol</span> <span class="string">"^([%+%-%*/%^&lt;>=#])"</span>]]))
     <span class="comment">;[:bracket "^([%(%)%[%]{}])"] ; Too noisy for regular use
</span>     <span class="comment">;[:whitespace "^([ \n\t]+)"]
</span>
(<span class="symbol special">fn</span> <span class="symbol">lua->html</span> [<span class="symbol">syntax</span> <span class="symbol">source</span>]
  (<span class="symbol">->html</span> (<span class="symbol">fennel-syntax->lua-syntax</span> <span class="symbol">syntax</span>)
          <span class="symbol">lua-rules</span>
          <span class="symbol">source</span>))

{<span class="symbol special">:</span> <span class="symbol">fennel->html</span>
 <span class="keyword">:fennel_to_html</span> <span class="symbol">fennel->html</span>
 <span class="symbol special">:</span> <span class="symbol">lua->html</span>
 <span class="keyword">:lua_to_html</span> <span class="symbol">lua->html</span>}

<span class="symbol special">local</span> <span class="symbol special">function</span> <span class="symbol">scan</span>(<span class="symbol">source</span>, <span class="symbol">rules</span>)
  <span class="symbol special">local</span> <span class="symbol">current_index</span> <span class="symbol special">=</span> <span class="number">1</span>
  <span class="symbol special">local</span> <span class="symbol">last_matching_at</span> <span class="symbol special">=</span> <span class="number">0</span>
  <span class="symbol special">local</span> <span class="symbol special">function</span> <span class="symbol">at_eof_3f</span>()
    <span class="symbol special">return</span> (<span class="symbol">current_index</span> <span class="symbol special">></span> <span class="symbol global">string.len</span>(<span class="symbol">source</span>))
  <span class="symbol special">end</span>
  <span class="symbol special">local</span> <span class="symbol special">function</span> <span class="symbol">advance</span>(<span class="symbol">n</span>)
    <span class="symbol">current_index</span> <span class="symbol special">=</span> (<span class="symbol">current_index</span> <span class="symbol special">+</span> <span class="symbol">n</span>)
    <span class="symbol special">return</span> <span class="nil">nil</span>
  <span class="symbol special">end</span>
  <span class="symbol special">local</span> <span class="symbol special">function</span> <span class="symbol">yield_nonmatching</span>()
    <span class="symbol special">if</span> (<span class="symbol">current_index</span> <span class="symbol special">></span> (<span class="number">1</span> <span class="symbol special">+</span> <span class="symbol">last_matching_at</span>)) <span class="symbol special">then</span>
      <span class="symbol special">local</span> <span class="symbol">nonmatching</span> <span class="symbol special">=</span> <span class="symbol global">string.sub</span>(<span class="symbol">source</span>, (<span class="symbol">last_matching_at</span> <span class="symbol special">+</span> <span class="number">1</span>), (<span class="symbol">current_index</span> <span class="symbol special">-</span> <span class="number">1</span>))
      <span class="symbol special">return</span> <span class="symbol global">coroutine.yield</span>(<span class="string">"nonmatching"</span>, <span class="symbol">nonmatching</span>)
    <span class="symbol special">else</span>
      <span class="symbol special">return</span> <span class="nil">nil</span>
    <span class="symbol special">end</span>
  <span class="symbol special">end</span>
  <span class="symbol special">local</span> <span class="symbol special">function</span> <span class="symbol">yield_and_advance</span>(<span class="symbol">class</span>, <span class="symbol">matched</span>)
    <span class="symbol">yield_nonmatching</span>()
    <span class="symbol global">coroutine.yield</span>(<span class="symbol">class</span>, <span class="symbol">matched</span>)
    <span class="symbol">advance</span>(<span class="symbol global">string.len</span>(<span class="symbol">matched</span>))
    <span class="symbol">last_matching_at</span> <span class="symbol special">=</span> (<span class="symbol">current_index</span> <span class="symbol special">-</span> <span class="number">1</span>)
    <span class="symbol special">return</span> <span class="nil">nil</span>
  <span class="symbol special">end</span>
  <span class="symbol special">local</span> <span class="symbol special">function</span> <span class="symbol">test_rules</span>(<span class="symbol">rules0</span>)
    <span class="symbol special">local</span> <span class="symbol">matching_rule</span> <span class="symbol special">=</span> <span class="nil">nil</span>
    <span class="symbol special">for</span> <span class="symbol">_</span>, <span class="symbol">_2_</span> <span class="symbol special">in</span> <span class="symbol global">ipairs</span>(<span class="symbol">rules0</span>) <span class="symbol special">do</span>
      <span class="symbol special">local</span> <span class="symbol">_each_3_</span> <span class="symbol special">=</span> <span class="symbol">_2_</span>
      <span class="symbol special">local</span> <span class="symbol">class</span> <span class="symbol special">=</span> <span class="symbol">_each_3_</span>[<span class="number">1</span>]
      <span class="symbol special">local</span> <span class="symbol">pattern</span> <span class="symbol special">=</span> <span class="symbol">_each_3_</span>[<span class="number">2</span>]
      <span class="symbol special">if</span> <span class="symbol">matching_rule</span> <span class="symbol special">then</span> <span class="symbol special">break</span> <span class="symbol special">end</span>
      <span class="symbol special">local</span> <span class="symbol">_4_</span> <span class="symbol special">=</span> <span class="symbol global">string.match</span>(<span class="symbol">source</span>, <span class="symbol">pattern</span>, <span class="symbol">current_index</span>)
      <span class="symbol special">if</span> (<span class="nil">nil</span> <span class="symbol special">~=</span> <span class="symbol">_4_</span>) <span class="symbol special">then</span>
        <span class="symbol special">local</span> <span class="symbol">str</span> <span class="symbol special">=</span> <span class="symbol">_4_</span>
        <span class="symbol">matching_rule</span> <span class="symbol special">=</span> {<span class="symbol">class</span>, <span class="symbol">str</span>}
      <span class="symbol special">else</span>
        <span class="symbol">matching_rule</span> <span class="symbol special">=</span> <span class="nil">nil</span>
      <span class="symbol special">end</span>
    <span class="symbol special">end</span>
    <span class="symbol special">return</span> <span class="symbol">matching_rule</span>
  <span class="symbol special">end</span>
  <span class="symbol special">while</span> <span class="symbol special">not</span> <span class="symbol">at_eof_3f</span>() <span class="symbol special">do</span>
    <span class="symbol special">local</span> <span class="symbol">_6_</span> <span class="symbol special">=</span> <span class="symbol">test_rules</span>(<span class="symbol">rules</span>)
    <span class="symbol special">if</span> ((<span class="symbol">_G.type</span>(<span class="symbol">_6_</span>) <span class="symbol">==</span> <span class="string">"table"</span>) <span class="symbol special">and</span> (<span class="nil">nil</span> <span class="symbol special">~=</span> (<span class="symbol">_6_</span>)[<span class="number">1</span>]) <span class="symbol special">and</span> (<span class="nil">nil</span> <span class="symbol special">~=</span> (<span class="symbol">_6_</span>)[<span class="number">2</span>])) <span class="symbol special">then</span>
      <span class="symbol special">local</span> <span class="symbol">class</span> <span class="symbol special">=</span> (<span class="symbol">_6_</span>)[<span class="number">1</span>]
      <span class="symbol special">local</span> <span class="symbol">str</span> <span class="symbol special">=</span> (<span class="symbol">_6_</span>)[<span class="number">2</span>]
      <span class="symbol">yield_and_advance</span>(<span class="symbol">class</span>, <span class="symbol">str</span>)
    <span class="symbol special">elseif</span> <span class="boolean">true</span> <span class="symbol special">then</span>
      <span class="symbol special">local</span> <span class="symbol">_</span> <span class="symbol special">=</span> <span class="symbol">_6_</span>
      <span class="symbol">advance</span>(<span class="number">1</span>)
    <span class="symbol special">else</span>
    <span class="symbol special">end</span>
  <span class="symbol special">end</span>
  <span class="symbol special">return</span> <span class="symbol">yield_nonmatching</span>()
<span class="symbol special">end</span>
<span class="symbol special">local</span> <span class="symbol special">function</span> <span class="symbol">__3ehtml</span>(<span class="symbol">syntax</span>, <span class="symbol">rules</span>, <span class="symbol">source</span>)
  <span class="symbol special">local</span> <span class="symbol">tbl_17_auto</span> <span class="symbol special">=</span> {}
  <span class="symbol special">local</span> <span class="symbol">i_18_auto</span> <span class="symbol special">=</span> <span class="symbol special">#</span><span class="symbol">tbl_17_auto</span>
  <span class="symbol special">local</span> <span class="symbol special">function</span> <span class="symbol">_8_</span>()
    <span class="symbol special">return</span> <span class="symbol">scan</span>(<span class="symbol">source</span>, <span class="symbol">rules</span>)
  <span class="symbol special">end</span>
  <span class="symbol special">for</span> <span class="symbol">class</span>, <span class="symbol">value</span> <span class="symbol special">in</span> <span class="symbol global">coroutine.wrap</span>(<span class="symbol">_8_</span>) <span class="symbol special">do</span>
    <span class="symbol special">local</span> <span class="symbol">val_19_auto</span>
    <span class="symbol special">if</span> (<span class="string">"nonmatching"</span> <span class="symbol">==</span> <span class="symbol">class</span>) <span class="symbol special">then</span>
      <span class="symbol">val_19_auto</span> <span class="symbol special">=</span> <span class="symbol">value</span>
    <span class="symbol special">else</span>
      <span class="symbol special">local</span> <span class="symbol">extra</span>
      <span class="symbol special">if</span> (<span class="string">"symbol"</span> <span class="symbol">==</span> <span class="symbol">class</span>) <span class="symbol special">then</span>
        <span class="symbol special">local</span> <span class="symbol">_9_</span> <span class="symbol special">=</span> <span class="symbol">syntax</span>[<span class="symbol">value</span>]
        <span class="symbol special">if</span> ((<span class="symbol">_G.type</span>(<span class="symbol">_9_</span>) <span class="symbol">==</span> <span class="string">"table"</span>) <span class="symbol special">and</span> ((<span class="symbol">_9_</span>)[<span class="string">"special?"</span>] <span class="symbol">==</span> <span class="boolean">true</span>)) <span class="symbol special">then</span>
          <span class="symbol">extra</span> <span class="symbol special">=</span> <span class="string">"special"</span>
        <span class="symbol special">elseif</span> ((<span class="symbol">_G.type</span>(<span class="symbol">_9_</span>) <span class="symbol">==</span> <span class="string">"table"</span>) <span class="symbol special">and</span> ((<span class="symbol">_9_</span>)[<span class="string">"macro?"</span>] <span class="symbol">==</span> <span class="boolean">true</span>)) <span class="symbol special">then</span>
          <span class="symbol">extra</span> <span class="symbol special">=</span> <span class="string">"macro"</span>
        <span class="symbol special">elseif</span> ((<span class="symbol">_G.type</span>(<span class="symbol">_9_</span>) <span class="symbol">==</span> <span class="string">"table"</span>) <span class="symbol special">and</span> ((<span class="symbol">_9_</span>)[<span class="string">"global?"</span>] <span class="symbol">==</span> <span class="boolean">true</span>)) <span class="symbol special">then</span>
          <span class="symbol">extra</span> <span class="symbol special">=</span> <span class="string">"global"</span>
        <span class="symbol special">else</span>
          <span class="symbol">extra</span> <span class="symbol special">=</span> <span class="nil">nil</span>
        <span class="symbol special">end</span>
      <span class="symbol special">else</span>
        <span class="symbol">extra</span> <span class="symbol special">=</span> <span class="nil">nil</span>
      <span class="symbol special">end</span>
      <span class="symbol special">local</span> <span class="symbol">extended_class</span>
      <span class="symbol special">if</span> <span class="symbol">extra</span> <span class="symbol special">then</span>
        <span class="symbol">extended_class</span> <span class="symbol special">=</span> (<span class="symbol">class</span> <span class="symbol special">..</span> <span class="string">" "</span> <span class="symbol special">..</span> <span class="symbol">extra</span>)
      <span class="symbol special">else</span>
        <span class="symbol">extended_class</span> <span class="symbol special">=</span> <span class="symbol">class</span>
      <span class="symbol special">end</span>
      <span class="symbol special">local</span> <span class="symbol">escaped_value</span> <span class="symbol special">=</span> <span class="symbol global">string.gsub</span>(<span class="symbol global">string.gsub</span>(<span class="symbol">value</span>, <span class="string">"&amp;"</span>, <span class="string">"&amp;amp;"</span>), <span class="string">"&lt;"</span>, <span class="string">"&amp;lt;"</span>)
      <span class="symbol">val_19_auto</span> <span class="symbol special">=</span> <span class="symbol global">string.format</span>(<span class="string">"&lt;span class=\"%s\">%s&lt;/span>"</span>, <span class="symbol">extended_class</span>, <span class="symbol">escaped_value</span>)
    <span class="symbol special">end</span>
    <span class="symbol special">if</span> (<span class="nil">nil</span> <span class="symbol special">~=</span> <span class="symbol">val_19_auto</span>) <span class="symbol special">then</span>
      <span class="symbol">i_18_auto</span> <span class="symbol special">=</span> (<span class="symbol">i_18_auto</span> <span class="symbol special">+</span> <span class="number">1</span>)
      <span class="symbol special">do</span> <span class="symbol special">end</span> (<span class="symbol">tbl_17_auto</span>)[<span class="symbol">i_18_auto</span>] <span class="symbol special">=</span> <span class="symbol">val_19_auto</span>
    <span class="symbol special">else</span>
    <span class="symbol special">end</span>
  <span class="symbol special">end</span>
  <span class="symbol special">return</span> <span class="symbol">tbl_17_auto</span>
<span class="symbol special">end</span>
<span class="symbol special">local</span> <span class="symbol">fennel_rules</span>
<span class="symbol special">do</span>
  <span class="symbol special">local</span> <span class="symbol">symbol_char</span> <span class="symbol special">=</span> <span class="string">"!%$&amp;#%*%+%-%./:&lt;=>%?%^_a-zA-Z0-9"</span>
  <span class="symbol">fennel_rules</span> <span class="symbol special">=</span> {{<span class="string">"comment"</span>, <span class="string">"^(;[^\n]*[\n])"</span>}, {<span class="string">"string"</span>, <span class="string">"^(\"\")"</span>}, {<span class="string">"string"</span>, <span class="string">"^(\".-[^\\]\")"</span>}, {<span class="string">"keyword"</span>, (<span class="string">"^(:["</span> <span class="symbol special">..</span> <span class="symbol">symbol_char</span> <span class="symbol special">..</span> <span class="string">"]+)"</span>)}, {<span class="string">"number"</span>, <span class="string">"^([%+%-]?%d+[xX]?%d*%.?%d?)"</span>}, {<span class="string">"nil"</span>, (<span class="string">"^(nil)[^"</span> <span class="symbol special">..</span> <span class="symbol">symbol_char</span> <span class="symbol special">..</span> <span class="string">"]"</span>)}, {<span class="string">"boolean"</span>, (<span class="string">"^(true)[^"</span> <span class="symbol special">..</span> <span class="symbol">symbol_char</span> <span class="symbol special">..</span> <span class="string">"]"</span>)}, {<span class="string">"boolean"</span>, (<span class="string">"^(false)[^"</span> <span class="symbol special">..</span> <span class="symbol">symbol_char</span> <span class="symbol special">..</span> <span class="string">"]"</span>)}, {<span class="string">"symbol"</span>, (<span class="string">"^(["</span> <span class="symbol special">..</span> <span class="symbol">symbol_char</span> <span class="symbol special">..</span> <span class="string">"]+)"</span>)}}
<span class="symbol special">end</span>
<span class="symbol special">local</span> <span class="symbol special">function</span> <span class="symbol">fennel__3ehtml</span>(<span class="symbol">syntax</span>, <span class="symbol">source</span>)
  <span class="symbol special">return</span> <span class="symbol">__3ehtml</span>(<span class="symbol">syntax</span>, <span class="symbol">fennel_rules</span>, <span class="symbol">source</span>)
<span class="symbol special">end</span>
<span class="symbol special">local</span> <span class="symbol">lua_keywords</span> <span class="symbol special">=</span> {<span class="string">"and"</span>, <span class="string">"break"</span>, <span class="string">"do"</span>, <span class="string">"else"</span>, <span class="string">"elseif"</span>, <span class="string">"end"</span>, <span class="string">"for"</span>, <span class="string">"function"</span>, <span class="string">"goto"</span>, <span class="string">"if"</span>, <span class="string">"in"</span>, <span class="string">"local"</span>, <span class="string">"not"</span>, <span class="string">"or"</span>, <span class="string">"repeat"</span>, <span class="string">"return"</span>, <span class="string">"then"</span>, <span class="string">"until"</span>, <span class="string">"while"</span>}
<span class="symbol special">local</span> <span class="symbol special">function</span> <span class="symbol">fennel_syntax__3elua_syntax</span>(<span class="symbol">fennel_syntax</span>)
  <span class="symbol special">local</span> <span class="symbol">lua_syntax</span> <span class="symbol special">=</span> {}
  <span class="symbol special">do</span>
    <span class="symbol special">local</span> <span class="symbol">tbl_14_auto</span> <span class="symbol special">=</span> <span class="symbol">lua_syntax</span>
    <span class="symbol special">for</span> <span class="symbol">k</span>, <span class="symbol">v</span> <span class="symbol special">in</span> <span class="symbol global">pairs</span>(<span class="symbol">fennel_syntax</span>) <span class="symbol special">do</span>
      <span class="symbol special">local</span> <span class="symbol">k_15_auto</span>, <span class="symbol">v_16_auto</span> <span class="symbol special">=</span> <span class="nil">nil</span>, <span class="nil">nil</span>
      <span class="symbol special">if</span> (<span class="symbol">v</span>[<span class="string">"global?"</span>] <span class="symbol special">or</span> <span class="symbol">v</span>[<span class="string">"special?"</span>]) <span class="symbol special">then</span>
        <span class="symbol">k_15_auto</span>, <span class="symbol">v_16_auto</span> <span class="symbol special">=</span> <span class="symbol">k</span>, <span class="symbol">v</span>
      <span class="symbol special">else</span>
        <span class="symbol">k_15_auto</span>, <span class="symbol">v_16_auto</span> <span class="symbol special">=</span> <span class="nil">nil</span>
      <span class="symbol special">end</span>
      <span class="symbol special">if</span> ((<span class="symbol">k_15_auto</span> <span class="symbol special">~=</span> <span class="nil">nil</span>) <span class="symbol special">and</span> (<span class="symbol">v_16_auto</span> <span class="symbol special">~=</span> <span class="nil">nil</span>)) <span class="symbol special">then</span>
        <span class="symbol">tbl_14_auto</span>[<span class="symbol">k_15_auto</span>] <span class="symbol special">=</span> <span class="symbol">v_16_auto</span>
      <span class="symbol special">else</span>
      <span class="symbol special">end</span>
    <span class="symbol special">end</span>
  <span class="symbol special">end</span>
  <span class="symbol special">do</span>
    <span class="symbol special">local</span> <span class="symbol">tbl_14_auto</span> <span class="symbol special">=</span> <span class="symbol">lua_syntax</span>
    <span class="symbol special">for</span> <span class="symbol">_</span>, <span class="symbol">k</span> <span class="symbol special">in</span> <span class="symbol global">ipairs</span>(<span class="symbol">lua_keywords</span>) <span class="symbol special">do</span>
      <span class="symbol special">local</span> <span class="symbol">k_15_auto</span>, <span class="symbol">v_16_auto</span> <span class="symbol special">=</span> <span class="symbol">k</span>, {[<span class="string">"special?"</span>] <span class="symbol special">=</span> <span class="boolean">true</span>}
      <span class="symbol special">if</span> ((<span class="symbol">k_15_auto</span> <span class="symbol special">~=</span> <span class="nil">nil</span>) <span class="symbol special">and</span> (<span class="symbol">v_16_auto</span> <span class="symbol special">~=</span> <span class="nil">nil</span>)) <span class="symbol special">then</span>
        <span class="symbol">tbl_14_auto</span>[<span class="symbol">k_15_auto</span>] <span class="symbol special">=</span> <span class="symbol">v_16_auto</span>
      <span class="symbol special">else</span>
      <span class="symbol special">end</span>
    <span class="symbol special">end</span>
  <span class="symbol special">end</span>
  <span class="symbol special">return</span> <span class="symbol">lua_syntax</span>
<span class="symbol special">end</span>
<span class="symbol special">local</span> <span class="symbol">lua_rules</span>
<span class="symbol special">do</span>
  <span class="symbol special">local</span> <span class="symbol">symbol_char_first</span> <span class="symbol special">=</span> <span class="string">"a-zA-Z_"</span>
  <span class="symbol special">local</span> <span class="symbol">symbol_char_rest</span> <span class="symbol special">=</span> (<span class="symbol">symbol_char_first</span> <span class="symbol special">..</span> <span class="string">"0-9%."</span>)
  <span class="symbol">lua_rules</span> <span class="symbol special">=</span> {{<span class="string">"comment"</span>, <span class="string">"^(%-%-%[===%[.-]===])"</span>}, {<span class="string">"comment"</span>, <span class="string">"^(%-%-%[==%[.-]==])"</span>}, {<span class="string">"comment"</span>, <span class="string">"^(%-%-%[=%[.-]=])"</span>}, {<span class="string">"comment"</span>, <span class="string">"^(%-%-%[%[.-]])"</span>}, {<span class="string">"comment"</span>, <span class="string">"^(%-%-[^\n]*[\n])"</span>}, {<span class="string">"string"</span>, <span class="string">"^(\"\")"</span>}, {<span class="string">"string"</span>, <span class="string">"^(%[%[.-]])"</span>}, {<span class="string">"string"</span>, <span class="string">"^(\".-[^\\]\")"</span>}, {<span class="string">"string"</span>, <span class="string">"^('.-[^\\]')"</span>}, {<span class="string">"number"</span>, <span class="string">"^(0[xX][0-9a-fA-F]?%.[0-9a-fA-F]+[eE][+-]?[0-9]?)"</span>}, {<span class="string">"number"</span>, <span class="string">"^(0[xX][0-9a-fA-F]+[eE][+-]?[0-9]?)"</span>}, {<span class="string">"number"</span>, <span class="string">"^(0[xX][0-9a-fA-F]?%.[0-9a-fA-F]+)"</span>}, {<span class="string">"number"</span>, <span class="string">"^(0[xX][0-9a-fA-F]+)"</span>}, {<span class="string">"number"</span>, <span class="string">"^([0-9]?%.[0-9]+[eE][+-]?[0-9]?)"</span>}, {<span class="string">"number"</span>, <span class="string">"^([0-9]+[eE][+-]?[0-9]?)"</span>}, {<span class="string">"number"</span>, <span class="string">"^([0-9]?%.[0-9]+)"</span>}, {<span class="string">"number"</span>, <span class="string">"^([0-9]+)"</span>}, {<span class="string">"nil"</span>, (<span class="string">"^(nil)[^"</span> <span class="symbol special">..</span> <span class="symbol">symbol_char_rest</span> <span class="symbol special">..</span> <span class="string">"]"</span>)}, {<span class="string">"boolean"</span>, (<span class="string">"^(true)[^"</span> <span class="symbol special">..</span> <span class="symbol">symbol_char_rest</span> <span class="symbol special">..</span> <span class="string">"]"</span>)}, {<span class="string">"boolean"</span>, (<span class="string">"^(false)[^"</span> <span class="symbol special">..</span> <span class="symbol">symbol_char_rest</span> <span class="symbol special">..</span> <span class="string">"]"</span>)}, {<span class="string">"symbol"</span>, (<span class="string">"^(["</span> <span class="symbol special">..</span> <span class="symbol">symbol_char_first</span> <span class="symbol special">..</span> <span class="string">"]["</span> <span class="symbol special">..</span> <span class="symbol">symbol_char_rest</span> <span class="symbol special">..</span> <span class="string">"]*)"</span>)}, {<span class="string">"symbol"</span>, <span class="string">"^(&lt;=)"</span>}, {<span class="string">"symbol"</span>, <span class="string">"^(>=)"</span>}, {<span class="string">"symbol"</span>, <span class="string">"^(==)"</span>}, {<span class="string">"symbol"</span>, <span class="string">"^(~=)"</span>}, {<span class="string">"symbol"</span>, <span class="string">"^(%.%.)"</span>}, {<span class="string">"symbol"</span>, <span class="string">"^([%+%-%*/%^&lt;>=#])"</span>}}
<span class="symbol special">end</span>
<span class="symbol special">local</span> <span class="symbol special">function</span> <span class="symbol">lua__3ehtml</span>(<span class="symbol">syntax</span>, <span class="symbol">source</span>)
  <span class="symbol special">return</span> <span class="symbol">__3ehtml</span>(<span class="symbol">fennel_syntax__3elua_syntax</span>(<span class="symbol">syntax</span>), <span class="symbol">lua_rules</span>, <span class="symbol">source</span>)
<span class="symbol special">end</span>
<span class="symbol special">return</span> {[<span class="string">"fennel->html"</span>] <span class="symbol special">=</span> <span class="symbol">fennel__3ehtml</span>, <span class="symbol">fennel_to_html</span> <span class="symbol special">=</span> <span class="symbol">fennel__3ehtml</span>, [<span class="string">"lua->html"</span>] <span class="symbol special">=</span> <span class="symbol">lua__3ehtml</span>, <span class="symbol">lua_to_html</span> <span class="symbol special">=</span> <span class="symbol">lua__3ehtml</span>}
